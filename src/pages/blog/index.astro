---
export const prerender = true;

import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import PageContainer from "@components/PageContainer.astro";
import PageHeader from "@components/PageHeader.astro";
import Section from "@components/Section.astro";
import ArrowCard from "@components/ArrowCard.astro";
import { BLOG } from "@lib/config";
import { sortByDateDesc } from "@lib/utils";

const allPosts = await getCollection("blog", ({ data }) => {
  return !data.draft;
});

const sortedPosts = sortByDateDesc(allPosts);

const postsByYear = sortedPosts.reduce(
  (acc, post) => {
    const year = new Date(post.data.date).getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof sortedPosts>,
);

const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<PageLayout
  title={BLOG.TITLE}
  description={BLOG.DESCRIPTION}
  currentPath="/blog/"
>
  <PageContainer spacing="md">
    <PageHeader title={BLOG.TITLE} size="lg" />

    {
      years.map((year) => (
        <Section spacing="md">
          <div class="flex justify-end">
            <h2 class="text-primary font-display text-xl font-semibold">
              {year}
            </h2>
          </div>
          <div class="space-y-4">
            {postsByYear[year].map((post) => (
              <ArrowCard entry={post} />
            ))}
          </div>
        </Section>
      ))
    }

    {
      sortedPosts.length === 0 && (
        <div class="py-12 text-center">
          <p class="text-text-secondary dark:text-text-secondary-dark">
            No blog posts found.
          </p>
        </div>
      )
    }
  </PageContainer>
</PageLayout>
