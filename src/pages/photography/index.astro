---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import PhotoCard from "@components/PhotoCard.astro";
import PhotoLightbox from "@components/PhotoLightbox.astro";
import { PHOTOGRAPHY } from "@lib/constants.ts";
import { generateImageStructuredData } from "@lib/photo-utils";

const allPhotos = await getCollection("photography", ({ data }) => {
  return !data.draft;
});

const sortedPhotos = allPhotos.sort(
  (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf(),
);

// Group photos by year
const photosByYear = sortedPhotos.reduce(
  (acc, photo) => {
    const year = new Date(photo.data.date).getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(photo);
    return acc;
  },
  {} as Record<number, typeof sortedPhotos>,
);

const years = Object.keys(photosByYear)
  .map(Number)
  .sort((a, b) => b - a);

const structuredData = generateImageStructuredData(sortedPhotos);
---

<PageLayout
  title={PHOTOGRAPHY.TITLE}
  description={PHOTOGRAPHY.DESCRIPTION}
  currentPath="/photography/"
  ogType="website"
  keywords="photography, photos, art, creative, visual"
>
  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />

  <Container>
    <div class="space-y-12">
      <div class="animate">
        <h1 class="font-display text-2xl font-semibold text-text-primary">
          {PHOTOGRAPHY.TITLE}
        </h1>
        <p class="mt-4 text-text-secondary dark:text-text-secondary-dark">
          {PHOTOGRAPHY.DESCRIPTION}
        </p>
      </div>

      <div class="space-y-12">
        {
          years.map((year) => (
            <section class="animate space-y-6" aria-labelledby={`year-${year}`}>
              <div class="flex justify-end">
                <h2
                  id={`year-${year}`}
                  class="font-display text-xl font-semibold text-text-primary"
                >
                  {year}
                </h2>
              </div>

              <div
                class="space-y-4"
                role="list"
                aria-label={`Photos from ${year}`}
              >
                {photosByYear[year].map((photo) => (
                  <div role="listitem">
                    <PhotoCard entry={photo} />
                  </div>
                ))}
              </div>
            </section>
          ))
        }
      </div>

      {
        sortedPhotos.length === 0 && (
          <div class="animate text-center py-12">
            <p class="text-text-secondary">No photos found.</p>
          </div>
        )
      }
    </div>
  </Container>
  <PhotoLightbox />
</PageLayout>
