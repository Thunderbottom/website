---

---

<div
  id="photo-lightbox"
  class="pointer-events-none fixed inset-0 z-[9999] bg-black/90 opacity-0 backdrop-blur-md transition-all duration-300"
  aria-hidden="true"
  role="dialog"
  aria-modal="true"
  aria-labelledby="lightbox-title"
  aria-describedby="lightbox-content"
>
  <!-- Close button -->
  <button
    id="lightbox-close"
    class="absolute right-4 top-4 z-10 rounded-lg bg-black/20 p-3 text-white transition-colors hover:bg-black/70 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
    aria-label="Close photo viewer"
    type="button"
  >
    <svg
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      aria-hidden="true"
    >
      <path d="M18 6L6 18M6 6l12 12"></path>
    </svg>
  </button>

  <div class="absolute inset-0 flex items-center justify-center p-4 pb-32">
    <div class="relative flex h-full w-full items-center justify-center">
      <!-- Previous button -->
      <button
        id="lightbox-prev"
        class="absolute left-4 top-1/2 z-10 -translate-y-1/2 rounded-lg bg-black/20 p-3 text-white opacity-80 transition-colors hover:bg-black/70 hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
        aria-label="Previous photo"
        type="button"
        style="display: none;"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>

      <!-- Next button -->
      <button
        id="lightbox-next"
        class="absolute right-4 top-1/2 z-10 -translate-y-1/2 rounded-lg bg-black/20 p-3 text-white opacity-80 transition-colors hover:bg-black/70 hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-black"
        aria-label="Next photo"
        type="button"
        style="display: none;"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>

      <img
        id="lightbox-image"
        src=""
        alt=""
        class="max-h-full max-w-full rounded-lg object-contain opacity-0 shadow-2xl transition-opacity duration-300"
        style="image-orientation: from-image; width: auto; height: auto;"
      />

      <div
        id="lightbox-loading"
        class="absolute inset-0 flex items-center justify-center rounded-lg"
        style="display: flex;"
        aria-live="polite"
        aria-label="Loading photo"
      >
        <div
          class="h-8 w-8 animate-spin rounded-full border-2 border-white border-t-transparent"
          aria-hidden="true"
        >
        </div>
        <span class="sr-only">Loading photo...</span>
      </div>
    </div>
  </div>

  <div
    class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/95 via-black/80 to-transparent p-6 text-white"
  >
    <div class="mx-auto max-w-4xl text-center">
      <h2
        id="lightbox-title"
        class="mb-2 font-display text-xl font-semibold text-gray-200"
      >
      </h2>
      <div id="lightbox-content" class="text-sm leading-relaxed text-gray-300">
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * Static photo lightbox - simplified for client-side only navigation
   */
  class StaticPhotoLightbox {
    constructor() {
      this.elements = this.getElements();
      this.state = {
        scrollPosition: 0,
        currentPhotoIndex: 0,
        allPhotos: [],
        isOpen: false,
      };

      this.boundEventHandlers = {
        keydown: this.handleKeydown.bind(this),
        click: this.handleBackdropClick.bind(this),
      };

      if (this.elements.isValid) {
        this.initialize();
      }
    }

    /**
     * Get and validate DOM elements
     */
    getElements() {
      const lightbox = document.getElementById("photo-lightbox");
      const lightboxImage = document.getElementById("lightbox-image");
      const lightboxTitle = document.getElementById("lightbox-title");
      const lightboxContent = document.getElementById("lightbox-content");
      const lightboxLoading = document.getElementById("lightbox-loading");
      const closeButton = document.getElementById("lightbox-close");
      const prevButton = document.getElementById("lightbox-prev");
      const nextButton = document.getElementById("lightbox-next");

      const isValid =
        lightbox &&
        lightboxImage &&
        lightboxTitle &&
        lightboxContent &&
        lightboxLoading &&
        closeButton &&
        prevButton &&
        nextButton;

      return {
        lightbox,
        lightboxImage,
        lightboxTitle,
        lightboxContent,
        lightboxLoading,
        closeButton,
        prevButton,
        nextButton,
        isValid,
      };
    }

    /**
     * Initialize the lightbox
     */
    initialize() {
      this.setupEventListeners();
      this.setupPhotoTriggers();

      // Expose methods globally for infinite scroll integration
      window.setupPhotoLightboxTriggers = this.setupPhotoTriggers.bind(this);
      window.staticPhotoLightboxInstance = this;

      console.log("[StaticPhotoLightbox] Initialized successfully");
    }

    /**
     * Setup event listeners
     */
    setupEventListeners() {
      // Button event listeners
      this.elements.closeButton.addEventListener(
        "click",
        this.closeLightbox.bind(this),
      );
      this.elements.prevButton.addEventListener(
        "click",
        this.goToPrevPhoto.bind(this),
      );
      this.elements.nextButton.addEventListener(
        "click",
        this.goToNextPhoto.bind(this),
      );

      // Backdrop click to close
      this.elements.lightbox.addEventListener(
        "click",
        this.boundEventHandlers.click,
      );

      // Keyboard navigation
      document.addEventListener("keydown", this.boundEventHandlers.keydown);
    }

    /**
     * Setup photo trigger elements
     */
    setupPhotoTriggers() {
      // Remove existing event listeners to prevent duplicates
      document.querySelectorAll("[data-photo-trigger]").forEach((trigger) => {
        // Clone node to remove all event listeners
        const newTrigger = trigger.cloneNode(true);
        trigger.parentNode?.replaceChild(newTrigger, trigger);
      });

      // Add fresh event listeners to all triggers
      document.querySelectorAll("[data-photo-trigger]").forEach((trigger) => {
        // Mouse click
        trigger.addEventListener("click", (event) => {
          event.preventDefault();
          this.openLightbox(trigger);
        });

        // Keyboard support (Enter/Space)
        trigger.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            this.openLightbox(trigger);
          }
        });
      });
    }

    /**
     * Get all photo triggers from the page
     */
    getAllPhotos() {
      return Array.from(document.querySelectorAll("[data-photo-trigger]"));
    }

    /**
     * Update navigation button visibility
     */
    updateNavigationButtons() {
      // Always refresh the photos list to include any newly loaded photos
      this.state.allPhotos = this.getAllPhotos();

      const { prevButton, nextButton } = this.elements;
      const { currentPhotoIndex, allPhotos } = this.state;

      prevButton.style.display = currentPhotoIndex > 0 ? "block" : "none";

      // Disable next button only if we're at the last photo AND no more photos can be loaded
      const hasMoreLoadedPhotos = currentPhotoIndex < allPhotos.length - 1;
      const hasMorePhotosToLoad =
        window.staticPhotoLoader && window.staticPhotoLoader.hasMorePhotos();

      nextButton.style.display =
        hasMoreLoadedPhotos || hasMorePhotosToLoad ? "block" : "none";

      // Update ARIA labels with context
      if (currentPhotoIndex > 0) {
        prevButton.setAttribute(
          "aria-label",
          `Previous photo (${currentPhotoIndex} of ${allPhotos.length})`,
        );
      }

      nextButton.setAttribute(
        "aria-label",
        hasMoreLoadedPhotos || hasMorePhotosToLoad
          ? `Next photo (${currentPhotoIndex + 2})`
          : "No more photos available",
      );
    }

    /**
     * Load and display a photo
     */
    loadPhoto(photoElement) {
      const fullImage = photoElement.getAttribute("data-full-image");
      const title = photoElement.getAttribute("data-title");
      const content = photoElement.getAttribute("data-content");

      if (!fullImage || !title) {
        console.warn("[StaticPhotoLightbox] Missing required photo data");
        return;
      }

      const { lightboxTitle, lightboxContent, lightboxLoading, lightboxImage } =
        this.elements;

      // Decode HTML entities and set title
      if (title && title.trim()) {
        const titleTempDiv = document.createElement("div");
        titleTempDiv.innerHTML = title.trim();
        lightboxTitle.textContent =
          titleTempDiv.textContent || titleTempDiv.innerText || "";
      } else {
        lightboxTitle.textContent = "";
      }

      // Decode HTML entities and set as text content
      if (content && content.trim()) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = content.trim();
        lightboxContent.textContent =
          tempDiv.textContent || tempDiv.innerText || "";
      } else {
        lightboxContent.textContent = "";
      }

      // Show loading state
      lightboxLoading.style.display = "flex";
      lightboxImage.style.opacity = "0";

      // Preload image
      const img = new Image();

      img.onload = () => {
        lightboxImage.src = img.src;
        lightboxImage.alt = title;
        lightboxLoading.style.display = "none";
        lightboxImage.style.opacity = "1";

        // Focus the image for screen readers
        lightboxImage.focus();
      };

      img.onerror = () => {
        console.error("[StaticPhotoLightbox] Failed to load image:", fullImage);
        lightboxLoading.style.display = "none";
        lightboxImage.style.opacity = "1";

        // Show error state
        lightboxImage.alt = `Failed to load: ${title}`;
        lightboxImage.src =
          "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDlWMTNNMTIgMTdIMTIuMDFNMjEgMTJDMjEgMTYuOTcwNiAxNi45NzA2IDIxIDEyIDIxQzcuMDI5NCAyMSAzIDE2Ljk3MDYgMyAxMkMzIDcuMDI5NCA3LjAyOTQgMyAxMiAzQzE2Ljk3MDYgMyAyMSA3LjAyOTQgMjEgMTJaIiBzdHJva2U9InJlZCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+"; // Error icon as data URL
      };

      img.src = fullImage;
      this.updateNavigationButtons();
    }

    /**
     * Open the lightbox
     */
    openLightbox(trigger) {
      this.state.allPhotos = this.getAllPhotos();
      this.state.currentPhotoIndex = this.state.allPhotos.indexOf(trigger);

      if (this.state.currentPhotoIndex === -1) {
        console.warn(
          "[StaticPhotoLightbox] Photo trigger not found in collection",
        );
        return;
      }

      // Store scroll position
      this.state.scrollPosition = window.pageYOffset;
      this.state.isOpen = true;

      // Show lightbox
      this.elements.lightbox.classList.remove(
        "opacity-0",
        "pointer-events-none",
      );
      this.elements.lightbox.setAttribute("aria-hidden", "false");

      // Prevent body scroll
      document.body.style.overflow = "hidden";
      document.body.style.position = "fixed";
      document.body.style.top = `-${this.state.scrollPosition}px`;
      document.body.style.width = "100%";

      // Load the photo
      this.loadPhoto(trigger);

      // Focus the close button for accessibility
      setTimeout(() => {
        this.elements.closeButton.focus();
      }, 100);

      console.log(
        `[StaticPhotoLightbox] Opened photo ${this.state.currentPhotoIndex + 1} of ${this.state.allPhotos.length}`,
      );
    }

    /**
     * Close the lightbox
     */
    closeLightbox() {
      this.state.isOpen = false;

      // Hide lightbox
      this.elements.lightbox.classList.add("opacity-0", "pointer-events-none");
      this.elements.lightbox.setAttribute("aria-hidden", "true");

      // Restore body scroll
      document.body.style.overflow = "";
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.width = "";

      // Restore scroll position after DOM updates complete
      requestAnimationFrame(() => {
        window.scrollTo({
          top: this.state.scrollPosition,
          left: 0,
          behavior: "instant",
        });
      });

      // Clear image
      this.elements.lightboxImage.src = "";
      this.elements.lightboxImage.style.opacity = "0";
      this.elements.lightboxLoading.style.display = "flex";

      console.log("[StaticPhotoLightbox] Closed");
    }

    /**
     * Navigate to next photo
     */
    goToNextPhoto() {
      // Always refresh photos list to include any newly loaded photos
      this.state.allPhotos = this.getAllPhotos();

      if (this.state.currentPhotoIndex < this.state.allPhotos.length - 1) {
        this.state.currentPhotoIndex++;
        this.loadPhoto(this.state.allPhotos[this.state.currentPhotoIndex]);
      } else if (
        window.staticPhotoLoader &&
        window.staticPhotoLoader.hasMorePhotos()
      ) {
        // Load more photos and then advance
        window.staticPhotoLoader.loadMorePhotos().then(() => {
          this.state.allPhotos = this.getAllPhotos();
          if (this.state.currentPhotoIndex < this.state.allPhotos.length - 1) {
            this.state.currentPhotoIndex++;
            this.loadPhoto(this.state.allPhotos[this.state.currentPhotoIndex]);
          }
        });
      }
    }

    /**
     * Navigate to previous photo
     */
    goToPrevPhoto() {
      // Refresh photos list
      this.state.allPhotos = this.getAllPhotos();

      if (this.state.currentPhotoIndex > 0) {
        this.state.currentPhotoIndex--;
        this.loadPhoto(this.state.allPhotos[this.state.currentPhotoIndex]);

        console.log(
          `[StaticPhotoLightbox] Previous photo: ${this.state.currentPhotoIndex + 1} of ${this.state.allPhotos.length}`,
        );
      }
    }

    /**
     * Handle keyboard navigation
     */
    handleKeydown(event) {
      if (!this.state.isOpen) return;

      switch (event.key) {
        case "Escape":
          event.preventDefault();
          this.closeLightbox();
          break;
        case "ArrowLeft":
          event.preventDefault();
          this.goToPrevPhoto();
          break;
        case "ArrowRight":
          event.preventDefault();
          this.goToNextPhoto();
          break;
        case "Home":
          event.preventDefault();
          if (this.state.allPhotos.length > 0) {
            this.state.currentPhotoIndex = 0;
            this.loadPhoto(this.state.allPhotos[0]);
          }
          break;
        case "End":
          event.preventDefault();
          if (this.state.allPhotos.length > 0) {
            this.state.currentPhotoIndex = this.state.allPhotos.length - 1;
            this.loadPhoto(this.state.allPhotos[this.state.currentPhotoIndex]);
          }
          break;
      }
    }

    /**
     * Handle backdrop clicks
     */
    handleBackdropClick(event) {
      if (event.target === this.elements.lightbox) {
        this.closeLightbox();
      }
    }

    /**
     * Cleanup event listeners
     */
    destroy() {
      document.removeEventListener("keydown", this.boundEventHandlers.keydown);
      this.elements.lightbox.removeEventListener(
        "click",
        this.boundEventHandlers.click,
      );

      // Remove global references
      delete window.setupPhotoLightboxTriggers;
      delete window.staticPhotoLightboxInstance;

      console.log("[StaticPhotoLightbox] Destroyed");
    }
  }

  // Initialize lightbox
  function initStaticLightbox() {
    // Destroy existing instance if it exists
    if (window.staticPhotoLightboxInstance) {
      window.staticPhotoLightboxInstance.destroy();
    }

    // Create new instance
    const lightbox = new StaticPhotoLightbox();

    return lightbox;
  }

  // Initialize on DOM ready and after page navigation
  document.addEventListener("DOMContentLoaded", initStaticLightbox);
  document.addEventListener("astro:after-swap", initStaticLightbox);
</script>

<style>
  /* Ensure lightbox is hidden by default for accessibility */
  #photo-lightbox[aria-hidden="true"] {
    display: none;
  }

  /* Smooth transitions for better user experience */
  #photo-lightbox img {
    transition: opacity 0.3s ease-in-out;
  }

  /* Focus styles for better accessibility */
  #photo-lightbox button:focus-visible {
    outline: 2px solid white;
    outline-offset: 2px;
  }
</style>
