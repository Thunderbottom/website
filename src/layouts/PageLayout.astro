---
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import BackToTop from "@components/BackToTop.astro";
import { SITE, AUTHOR } from "@lib/constants";
import "../styles/global.css";

interface Props {
  title?: string;
  description?: string;
  keywords?: string;
  ogType?: string;
  ogImage?: string;
  currentPath?: string;
}

const {
  title = "Home",
  description = SITE.DESCRIPTION,
  keywords = "astro, blog, technology, life, linux",
  ogType = "website",
  ogImage = "/logo.png",
  currentPath = "",
} = Astro.props;

const pageTitle = title === SITE.NAME ? title : `${title} | ${SITE.NAME}`;
const canonicalURL = new URL(currentPath, SITE.URL);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#f8fafc" />
    <meta
      name="theme-color"
      content="#0f0f19"
      media="(prefers-color-scheme: dark)"
    />

    <script is:inline>
      const storageKey = "theme-preference";

      const getColorPreference = () => {
        if (localStorage.getItem(storageKey))
          return localStorage.getItem(storageKey);
        else
          return window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
      };

      const setPreference = () => {
        localStorage.setItem(storageKey, theme.value);
        reflectPreference();
      };

      const reflectPreference = () => {
        // Use class-based approach to work with your existing CSS
        document.documentElement.classList.toggle(
          "dark",
          theme.value === "dark",
        );

        // Also set data-theme for the button styling
        document.firstElementChild.setAttribute("data-theme", theme.value);

        // Update theme-color meta tag
        const metaThemeColor = document.querySelector(
          'meta[name="theme-color"]:not([media])',
        );
        if (metaThemeColor) {
          metaThemeColor.content =
            theme.value === "dark" ? "#0f0f19" : "#f8fafc";
        }

        // Update button aria-label for accessibility
        document
          .querySelector("#theme-toggle")
          ?.setAttribute("aria-label", theme.value);
      };

      const theme = {
        value: getColorPreference(),
      };

      // Set early so no page flashes / CSS is made aware
      reflectPreference();

      const onClick = () => {
        theme.value = theme.value === "light" ? "dark" : "light";
        setPreference();
      };

      // Set up everything when DOM is ready
      window.addEventListener("DOMContentLoaded", () => {
        // Set on load so screen readers can see latest value on the button
        reflectPreference();

        // Now this script can find and listen for clicks on the control
        document
          .querySelector("#theme-toggle")
          ?.addEventListener("click", onClick);
      });

      // Sync with system changes
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", ({ matches: isDark }) => {
          theme.value = isDark ? "dark" : "light";
          setPreference();
        });

      // Handle Astro page transitions
      document.addEventListener("astro:after-swap", () => {
        reflectPreference();
        document
          .querySelector("#theme-toggle")
          ?.addEventListener("click", onClick);
      });

      // Animation and scroll functions
      function animate() {
        const animateElements = document.querySelectorAll(".animate");
        animateElements.forEach((element, index) => {
          setTimeout(() => {
            element.classList.add("show");
          }, index * 100);
        });
      }

      function onScroll() {
        document.documentElement.classList.toggle(
          "scrolled",
          window.scrollY > 0,
        );
      }

      function init() {
        animate();
        onScroll();
        document.addEventListener("scroll", onScroll);
      }

      window.addEventListener("DOMContentLoaded", init);
      document.addEventListener("astro:after-swap", init);
    </script>

    <!-- Primary Meta Tags -->
    <title>{pageTitle}</title>
    <meta name="title" content={pageTitle} />
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content={SITE.NAME} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- RSS Feed -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS"
      href="/rss.xml"
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content={SITE.NAME} />

    <!-- Favicons -->
    <link
      rel="icon"
      type="image/png"
      href="/icons/favicon/favicon-96x96.png"
      sizes="96x96"
    />
    <link rel="shortcut icon" href="/icons/favicon/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/icons/favicon/apple-touch-icon.png"
    />
    <meta name="apple-mobile-web-app-title" content={SITE.NAME} />
    <link rel="manifest" href="/icons/favicon/site.webmanifest" />

    <!-- Font Preloads -->
    <link
      rel="preload"
      href="/fonts/playfair-display/playfair-display-v22-latin-600.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/jetbrains-mono/jetbrains-mono-v20-latin-regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- Disable FLoC -->
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
  </head>

  <body>
    <Header />
    <main>
      <slot />
    </main>
    <Footer />
    <BackToTop />
  </body>
</html>
